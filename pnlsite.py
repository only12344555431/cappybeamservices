import logging
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
import html
import json

# Bot tokenƒ±nƒ±zƒ± buraya ekleyin
BOT_TOKEN = "7664476297:AAFKYsvjCW318-A9N8FYurPD1fFtzwMFozU"

# Sorgu durumlarƒ±
SELECT_CATEGORY, SELECT_SORGUTIPI, ENTER_PARAMETERS = range(3)

# T√ºm sorgu tipleri ve API u√ß noktalarƒ±
SORGU_TIPLERI = {
    "temel": {
        "name": "Temel Sorgular",
        "sorgular": {
            "tcpro": {
                "api": "https://api.hexnox.pro/sowixapi/tcpro.php",
                "params": ["tc"],
                "display": "TC Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "adsoyadilice": {
                "api": "https://api.hexnox.pro/sowixapi/adsoyadilice.php",
                "params": ["ad", "soyad"],
                "display": "Ad Soyad Sorgu",
                "input_text": "Ad ve soyad girin (√∂rn: Ahmet Yƒ±lmaz):"
            },
            "tcgsm": {
                "api": "https://api.hexnox.pro/sowixapi/tcgsm.php",
                "params": ["tc"],
                "display": "TC GSM Sorgu",
                "input_text": "TC kimlik no girin:"
            }
        }
    },
    "aile": {
        "name": "Aile Sorgularƒ±",
        "sorgular": {
            "anne": {
                "api": "https://api.hexnox.pro/sowixapi/anne.php",
                "params": ["tc"],
                "display": "Anne Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "baba": {
                "api": "https://api.hexnox.pro/sowixapi/baba.php",
                "params": ["tc"],
                "display": "Baba Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "cocuk": {
                "api": "http://api.hexnox.pro/sowixapi/cocuk.php",
                "params": ["tc"],
                "display": "√áocuk Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "sulale": {
                "api": "https://api.hexnox.pro/sowixapi/sulale.php",
                "params": ["tc"],
                "display": "S√ºlale Sorgu",
                "input_text": "TC kimlik no girin:"
            }
        }
    },
    "iletisim": {
        "name": "ƒ∞leti≈üim Sorgularƒ±",
        "sorgular": {
            "gsm": {
                "api": "https://api.hexnox.pro/sowixapi/gsm.php",
                "params": ["gsm"],
                "display": "GSM Sorgu",
                "input_text": "Telefon numarasƒ± girin (√∂rn: 5551234567):"
            },
            "gsmdetay": {
                "api": "https://api.hexnox.pro/sowixapi/gsmdetay.php",
                "params": ["gsm"],
                "display": "GSM Detay Sorgu",
                "input_text": "Telefon numarasƒ± girin (√∂rn: 5551234567):"
            },
            "operator": {
                "api": "https://api.hexnox.pro/sowixapi/operator.php",
                "params": ["gsm"],
                "display": "Operat√∂r Sorgu",
                "input_text": "Telefon numarasƒ± girin (√∂rn: 5551234567):"
            },
            "email_sorgu": {
                "api": "http://api.hexnox.pro/sowixapi/email_sorgu.php",
                "params": ["email"],
                "display": "Email Sorgu",
                "input_text": "Email adresi girin:"
            }
        }
    },
    "sosyal": {
        "name": "Sosyal Medya Sorgularƒ±",
        "sorgular": {
            "telegram_sorgu": {
                "api": "https://api.hexnox.pro/sowixapi/telegram_sorgu.php",
                "params": ["username"],
                "display": "Telegram Sorgu",
                "input_text": "Telegram kullanƒ±cƒ± adƒ± girin:"
            },
            "facebook": {
                "api": "https://hexnox.pro/sowixfree/facebook.php",
                "params": ["numara"],
                "display": "Facebook Sorgu",
                "input_text": "Telefon numarasƒ± girin:"
            }
        }
    },
    "adres": {
        "name": "Adres Sorgularƒ±",
        "sorgular": {
            "adres": {
                "api": "https://api.hexnox.pro/sowixapi/adres.php",
                "params": ["tc"],
                "display": "Adres Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "tapu": {
                "api": "https://api.hexnox.pro/sowixapi/tapu.php",
                "params": ["tc"],
                "display": "Tapu Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "premadres": {
                "api": "https://hexnox.pro/sowixfree/premadres.php",
                "params": ["tc"],
                "display": "Premadres Sorgu",
                "input_text": "TC kimlik no girin:"
            }
        }
    },
    "arac": {
        "name": "Ara√ß Sorgularƒ±",
        "sorgular": {
            "plaka": {
                "api": "http://hexnox.pro/sowixfree/plaka.php",
                "params": ["plaka"],
                "display": "Plaka Sorgu",
                "input_text": "Plaka no girin (√∂rn: 34ABC123):"
            },
            "aracparca": {
                "api": "https://hexnox.pro/sowixfree/aracparca.php",
                "params": ["plaka"],
                "display": "Ara√ß Par√ßa Sorgu",
                "input_text": "Plaka no girin (√∂rn: 34ABC123):"
            }
        }
    },
    "egitim": {
        "name": "Eƒüitim Sorgularƒ±",
        "sorgular": {
            "okulno": {
                "api": "https://api.hexnox.pro/sowixapi/okulno.php",
                "params": ["tc"],
                "display": "Okul No Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "lgs": {
                "api": "http://hexnox.pro/sowixfree/lgs/lgs.php",
                "params": ["tc"],
                "display": "LGS Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "diploma": {
                "api": "https://hexnox.pro/sowixfree/diploma/diploma.php",
                "params": ["tc"],
                "display": "Diploma Sorgu",
                "input_text": "TC kimlik no girin:"
            }
        }
    },
    "saglik": {
        "name": "Saƒülƒ±k Sorgularƒ±",
        "sorgular": {
            "mhrs": {
                "api": "https://hexnox.pro/sowixfree/mhrs/mhrs.php",
                "params": ["tc"],
                "display": "MHRS Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "boy": {
                "api": "http://api.hexnox.pro/sowixapi/boy.php",
                "params": ["tc"],
                "display": "Boy Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "ayak": {
                "api": "http://api.hexnox.pro/sowixapi/ayak.php",
                "params": ["tc"],
                "display": "Ayak No Sorgu",
                "input_text": "TC kimlik no girin:"
            }
        }
    },
    "ozel": {
        "name": "√ñzel Sorgular",
        "sorgular": {
            "imei": {
                "api": "https://api.hexnox.pro/sowixapi/imei.php",
                "params": ["imei"],
                "display": "IMEI Sorgu",
                "input_text": "IMEI numarasƒ± girin:"
            },
            "interpol": {
                "api": "https://hexnox.pro/sowixfree/interpol.php",
                "params": ["ad", "soyad"],
                "display": "Interpol Sorgu",
                "input_text": "Ad ve soyad girin (√∂rn: Ahmet Yƒ±lmaz):"
            },
            "burc": {
                "api": "http://api.hexnox.pro/sowixapi/burc.php",
                "params": ["tc"],
                "display": "Bur√ß Sorgu",
                "input_text": "TC kimlik no girin:"
            },
            "havadurumu": {
                "api": "http://api.hexnox.pro/sowixapi/havadurumu.php",
                "params": ["sehir"],
                "display": "Hava Durumu Sorgu",
                "input_text": "≈ûehir adƒ± girin (√∂rn: ƒ∞stanbul):"
            }
        }
    }
}

# Enable logging
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Botu ba≈ülatan komut."""
    user = update.effective_user

    # Kategori se√ßim butonlarƒ± olu≈ütur
    keyboard = []
    for category_id, category_data in SORGU_TIPLERI.items():
        keyboard.append([InlineKeyboardButton(category_data["name"], callback_data=f"category_{category_id}")])

    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        f"üëã Merhaba {user.first_name}! Ben Sorgu Botuyum.\n\n"
        "A≈üaƒüƒ±dan bir sorgu kategorisi se√ßin:",
        reply_markup=reply_markup
    )

    return SELECT_CATEGORY

async def category_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Kategori se√ßimini i≈üler."""
    query = update.callback_query
    await query.answer()

    category_id = query.data.replace("category_", "")

    if category_id not in SORGU_TIPLERI:
        await query.edit_message_text("Ge√ßersiz kategori se√ßimi.")
        return SELECT_CATEGORY

    # Se√ßilen kategoriye ait sorgu butonlarƒ±nƒ± olu≈ütur
    keyboard = []
    for sorgu_id, sorgu_data in SORGU_TIPLERI[category_id]["sorgular"].items():
        keyboard.append([InlineKeyboardButton(sorgu_data["display"], callback_data=f"sorgu_{sorgu_id}")])

    # Geri butonu ekle
    keyboard.append([InlineKeyboardButton("‚óÄÔ∏è Geri", callback_data="back_to_categories")])

    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        f"üìã {SORGU_TIPLERI[category_id]['name']}\n\n"
        "A≈üaƒüƒ±dan bir sorgu tipi se√ßin:",
        reply_markup=reply_markup
    )

    return SELECT_SORGUTIPI

async def sorgu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Sorgu tipi se√ßimini i≈üler."""
    query = update.callback_query
    await query.answer()

    if query.data == "back_to_categories":
        # Kategori se√ßimine geri d√∂n
        keyboard = []
        for category_id, category_data in SORGU_TIPLERI.items():
            keyboard.append([InlineKeyboardButton(category_data["name"], callback_data=f"category_{category_id}")])

        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            "A≈üaƒüƒ±dan bir sorgu kategorisi se√ßin:",
            reply_markup=reply_markup
        )
        return SELECT_CATEGORY

    sorgu_id = query.data.replace("sorgu_", "")

    # Sorgu tipini bul
    sorgu_data = None
    for category_id, category_data in SORGU_TIPLERI.items():
        if sorgu_id in category_data["sorgular"]:
            sorgu_data = category_data["sorgular"][sorgu_id]
            break

    if not sorgu_data:
        await query.edit_message_text("Ge√ßersiz sorgu tipi se√ßimi.")
        return SELECT_SORGUTIPI

    # Sorgu tipini context'te sakla
    context.user_data["selected_sorgu"] = {
        "id": sorgu_id,
        "data": sorgu_data
    }

    await query.edit_message_text(
        f"üîç {sorgu_data['display']}\n\n"
        f"{sorgu_data['input_text']}\n\n"
        "ƒ∞≈ülemi iptal etmek i√ßin /cancel yazƒ±n."
    )

    return ENTER_PARAMETERS

async def parameters_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Kullanƒ±cƒ±dan alƒ±nan parametreleri i≈üler ve API'yi √ßaƒüƒ±rƒ±r."""
    user_input = update.message.text
    selected_sorgu = context.user_data["selected_sorgu"]
    sorgu_data = selected_sorgu["data"]

    # Parametreleri ayƒ±r ve temizle
    params_list = [p.strip() for p in user_input.split()]
    required_params = sorgu_data["params"]

    if len(params_list) != len(required_params):
        await update.message.reply_text(
            f"‚ùå Eksik parametre! L√ºtfen {len(required_params)} parametre girin.\n\n"
            f"{sorgu_data['input_text']}\n\n"
            "ƒ∞≈ülemi iptal etmek i√ßin /cancel yazƒ±n."
        )
        return ENTER_PARAMETERS

    # API'yi √ßaƒüƒ±r
    api_url = sorgu_data["api"]
    query_params = {required_params[i]: params_list[i] for i in range(len(required_params))}

    try:
        # Sorgu yapƒ±lƒ±yor mesajƒ±
        processing_msg = await update.message.reply_text("‚è≥ Sorgunuz yapƒ±lƒ±yor, l√ºtfen bekleyin...")

        response = requests.get(api_url, params=query_params, timeout=30)

        if response.status_code == 200:
            result = response.text

            # JSON formatƒ±nda ise d√ºzenle
            try:
                if result.strip().startswith('{') or result.strip().startswith('['):
                    json_data = json.loads(result)
                    formatted_result = json.dumps(json_data, indent=2, ensure_ascii=False)
                    result = f"<pre>{html.escape(formatted_result)}</pre>"
            except:
                pass

            # Eƒüer sonu√ß bo≈üsa veya hata i√ßeriyorsa
            if not result or "error" in result.lower() or "hata" in result.lower():
                result = "‚ùå Sorgu sonucu bulunamadƒ± veya bir hata olu≈ütu."

            # Sonucu g√∂ster
            await processing_msg.edit_text(
                f"‚úÖ <b>{sorgu_data['display']} Sonucu:</b>\n\n"
                f"{result}\n\n"
                "Yeni sorgu yapmak i√ßin /sorgu yazƒ±n.",
                parse_mode="HTML"
            )
        else:
            await processing_msg.edit_text(
                "‚ùå Sorgu sƒ±rasƒ±nda bir hata olu≈ütu. API yanƒ±t vermedi.\n\n"
                "Yeni sorgu yapmak i√ßin /sorgu yazƒ±n."
            )

    except Exception as e:
        logger.error(f"API √ßaƒürƒ±sƒ± sƒ±rasƒ±nda hata: {e}")
        await processing_msg.edit_text(
            "‚ùå Sorgu sƒ±rasƒ±nda bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.\n\n"
            "Yeni sorgu yapmak i√ßin /sorgu yazƒ±n."
        )

    # Kullanƒ±cƒ± verilerini temizle
    if "selected_sorgu" in context.user_data:
        del context.user_data["selected_sorgu"]

    return -1

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Sorgu i≈ülemini iptal eder."""
    # Kullanƒ±cƒ± verilerini temizle
    if "selected_sorgu" in context.user_data:
        del context.user_data["selected_sorgu"]

    await update.message.reply_text(
        "‚ùå Sorgu i≈ülemi iptal edildi.\n\n"
        "Yeni sorgu yapmak i√ßin /sorgu yazƒ±n."
    )

    return -1

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Yardƒ±m komutunu i≈üler."""
    await update.message.reply_text(
        "ü§ñ <b>Sorgu Botu Kullanƒ±m Kƒ±lavuzu</b>\n\n"
        "‚Ä¢ <b>/start</b> - Botu ba≈ülatƒ±r\n"
        "‚Ä¢ <b>/sorgu</b> - Sorgu yapmaya ba≈ülar\n"
        "‚Ä¢ <b>/cancel</b> - Mevcut i≈ülemi iptal eder\n"
        "‚Ä¢ <b>/help</b> - Yardƒ±m mesajƒ±nƒ± g√∂sterir\n\n"
        "Sorgu yapmak i√ßin /sorgu komutunu kullanƒ±n ve a√ßƒ±lan men√ºlerden istediƒüiniz sorgu tipini se√ßin.",
        parse_mode="HTML"
    )

async def button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """D√ºƒüme tƒ±klamalarƒ±nƒ± i≈üler."""
    query = update.callback_query
    await query.answer()
    await query.edit_messaAge_text(text=f"Se√ßilen se√ßenek: {query.data}")

def main():
    """Botu ba≈ülatƒ±r."""
    # Application olu≈ütur
    application = Application.builder().token(BOT_TOKEN).build()

    # Handlers ekle
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("sorgu", start))
    application.add_handler(CommandHandler("cancel", cancel))
    application.add_handler(CommandHandler("help", help_command))

    application.add_handler(CallbackQueryHandler(category_handler, pattern="^category_"))
    application.add_handler(CallbackQueryHandler(sorgu_handler, pattern="^sorgu_"))
    application.add_handler(CallbackQueryHandler(sorgu_handler, pattern="^back_to_categories"))

    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, parameters_handler))

    # Botu √ßalƒ±≈ütƒ±r
    application.run_polling()

if __name__ == "__main__":
    main()

